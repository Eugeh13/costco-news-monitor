"""
M√≥dulo de notificaciones mejorado con soporte para an√°lisis de IA.
"""

import os
import requests
from datetime import datetime
from typing import Dict, Optional


class NotifierAI:
    """Clase mejorada para enviar notificaciones con informaci√≥n de IA."""
    
    def __init__(self, config: dict):
        """
        Inicializa el notificador.
        
        Args:
            config: Diccionario con configuraci√≥n de notificaciones
        """
        self.config = config
        self.telegram_enabled = config.get('telegram', False)
        self.console_enabled = config.get('console', True)
        
        # Obtener credenciales de Telegram desde variables de entorno
        self.telegram_token = os.environ.get('TELEGRAM_BOT_TOKEN')
        self.telegram_chat_id = os.environ.get('TELEGRAM_CHAT_ID')
        
        if self.telegram_enabled and not (self.telegram_token and self.telegram_chat_id):
            print("‚ö†Ô∏è  Advertencia: Telegram habilitado pero faltan credenciales")
            self.telegram_enabled = False
    
    def notify(self, data: Dict) -> bool:
        """
        Env√≠a una notificaci√≥n de alerta.
        
        Args:
            data: Diccionario con informaci√≥n de la noticia
        
        Returns:
            True si se envi√≥ correctamente
        """
        success = True
        
        if self.console_enabled:
            self._notify_console(data)
        
        if self.telegram_enabled:
            success = self._notify_telegram(data)
        
        return success
    
    def _notify_console(self, data: Dict):
        """Muestra la notificaci√≥n en consola."""
        print(f"\n{'='*70}")
        print(f"üö® ALERTA DE ALTO IMPACTO")
        print(f"{'='*70}")
        print(f"Categor√≠a: {data.get('categoria', 'N/A')}")
        print(f"T√≠tulo: {data.get('titulo', 'N/A')}")
        print(f"Ubicaci√≥n: {data.get('ubicacion', 'N/A')}")
        print(f"Distancia: {data.get('distancia_km', 'N/A')} km de {data.get('costco_cercano', 'N/A')}")
        
        # Informaci√≥n adicional de IA si est√° disponible
        if 'severity' in data:
            print(f"Severidad: {data['severity']}/10 {data.get('severity_emoji', '')}")
        if 'victims' in data and data['victims'] > 0:
            print(f"V√≠ctimas/Heridos: {data['victims']}")
        if 'traffic_impact' in data:
            impact = data['traffic_impact']
            impact_labels = {
                'none': 'Sin impacto',
                'low': 'Bajo',
                'medium': 'Moderado',
                'high': 'Alto'
            }
            print(f"Impacto en tr√°fico: {impact_labels.get(impact, impact)}")
        if data.get('emergency_services'):
            print(f"Servicios de emergencia: S√≠")
        
        print(f"Fuente: {data.get('fuente', 'N/A')}")
        print(f"URL: {data.get('url', 'N/A')}")
        print(f"{'='*70}\n")
    
    def _notify_telegram(self, data: Dict) -> bool:
        """
        Env√≠a notificaci√≥n a Telegram.
        
        Args:
            data: Diccionario con informaci√≥n de la noticia
        
        Returns:
            True si se envi√≥ correctamente
        """
        try:
            # Construir mensaje mejorado con informaci√≥n de IA
            severity_emoji = data.get('severity_emoji', 'üö®')
            categoria = data.get('categoria', 'Evento de Alto Impacto')
            titulo = data.get('titulo', 'Sin t√≠tulo')
            ubicacion = data.get('ubicacion', 'Ubicaci√≥n no especificada')
            distancia = data.get('distancia_km', 'N/A')
            costco = data.get('costco_cercano', 'N/A')
            fuente = data.get('fuente', 'N/A')
            url = data.get('url', '')
            resumen = data.get('resumen', '')
            
            # Construir mensaje base
            message = f"{severity_emoji} *ALERTA COSTCO MTY*\n\n"
            message += f"üìç *{categoria}*\n"
            message += f"üì∞ {titulo}\n\n"
            
            # Agregar informaci√≥n de severidad si est√° disponible
            if 'severity' in data:
                severity = data['severity']
                if severity >= 9:
                    severity_label = "CR√çTICA"
                elif severity >= 7:
                    severity_label = "GRAVE"
                elif severity >= 5:
                    severity_label = "MODERADA"
                else:
                    severity_label = "MENOR"
                message += f"‚ö° *Severidad: {severity_label}* ({severity}/10)\n"
            
            # Agregar detalles adicionales
            if 'victims' in data and data['victims'] > 0:
                message += f"üë• V√≠ctimas/Heridos: {data['victims']}\n"
            
            if 'traffic_impact' in data:
                impact = data['traffic_impact']
                if impact == 'high':
                    message += f"üöó Impacto en tr√°fico: *ALTO*\n"
                elif impact == 'medium':
                    message += f"üöó Impacto en tr√°fico: Moderado\n"
                elif impact == 'low':
                    message += f"üöó Impacto en tr√°fico: Bajo\n"
            
            if data.get('emergency_services'):
                message += f"üöë Servicios de emergencia en el lugar\n"
            
            message += f"\nüìè A *{distancia} km* de {costco}\n"
            message += f"üó∫Ô∏è {ubicacion}\n\n"
            
            # Agregar resumen si est√° disponible
            if resumen and len(resumen) > 0:
                message += f"üìù {resumen}\n\n"
            
            message += f"üì° {fuente}\n"
            
            if url and url != 'No disponible':
                message += f"üîó [Ver noticia completa]({url})\n"
            
            timestamp = datetime.now().strftime("%d/%m/%Y %H:%M")
            message += f"\n‚è∞ {timestamp}"
            
            # Enviar mensaje
            telegram_url = f"https://api.telegram.org/bot{self.telegram_token}/sendMessage"
            
            payload = {
                'chat_id': self.telegram_chat_id,
                'text': message,
                'parse_mode': 'Markdown',
                'disable_web_page_preview': False
            }
            
            response = requests.post(telegram_url, json=payload, timeout=10)
            
            if response.status_code == 200:
                print("‚úì Notificaci√≥n enviada a Telegram")
                return True
            else:
                print(f"‚ö†Ô∏è  Error enviando a Telegram: {response.status_code}")
                print(f"   Respuesta: {response.text}")
                return False
                
        except Exception as e:
            print(f"‚ö†Ô∏è  Error enviando notificaci√≥n a Telegram: {e}")
            return False
    
    def send_monitoring_summary(self, data: Dict) -> bool:
        """
        Env√≠a un resumen del monitoreo realizado.
        
        Args:
            data: Diccionario con estad√≠sticas del monitoreo
        
        Returns:
            True si se envi√≥ correctamente
        """
        if not self.telegram_enabled:
            return False
        
        try:
            timestamp = data.get('timestamp', datetime.now().strftime("%d/%m/%Y %H:%M"))
            news_analyzed = data.get('news_analyzed', 0)
            alerts_sent = data.get('alerts_sent', 0)
            
            message = "‚úÖ *Monitoreo Completado*\n\n"
            message += "üìä *Resumen:*\n"
            message += f"‚Ä¢ Noticias analizadas: {news_analyzed}\n"
            message += f"‚Ä¢ Alertas de alto impacto: {alerts_sent}\n"
            
            if alerts_sent == 0:
                message += "‚Ä¢ Estado: Todo tranquilo ‚úì\n"
            
            message += "\nüìç *√Åreas monitoreadas:*\n"
            message += "‚Ä¢ Costco Carretera Nacional\n"
            message += "‚Ä¢ Costco Cumbres\n"
            message += "‚Ä¢ Costco Valle Oriente\n"
            
            message += f"\n‚è∞ {timestamp}\n"
            message += "üîÑ Pr√≥ximo monitoreo en 30 minutos"
            
            telegram_url = f"https://api.telegram.org/bot{self.telegram_token}/sendMessage"
            
            payload = {
                'chat_id': self.telegram_chat_id,
                'text': message,
                'parse_mode': 'Markdown'
            }
            
            response = requests.post(telegram_url, json=payload, timeout=10)
            
            if response.status_code == 200:
                print("‚úì Resumen enviado a Telegram")
                return True
            else:
                print(f"‚ö†Ô∏è  Error enviando resumen: {response.status_code}")
                return False
                
        except Exception as e:
            print(f"‚ö†Ô∏è  Error enviando resumen: {e}")
            return False
    
    def send_test_message(self) -> bool:
        """
        Env√≠a un mensaje de prueba.
        
        Returns:
            True si se envi√≥ correctamente
        """
        if not self.telegram_enabled:
            print("‚ö†Ô∏è  Telegram no est√° habilitado")
            return False
        
        try:
            message = "ü§ñ *Test del Sistema de Monitoreo*\n\n"
            message += "‚úì Sistema con IA funcionando correctamente\n"
            message += "‚úì An√°lisis con OpenAI activo\n"
            message += "‚úì Notificaciones operativas\n\n"
            message += f"‚è∞ {datetime.now().strftime('%d/%m/%Y %H:%M')}"
            
            telegram_url = f"https://api.telegram.org/bot{self.telegram_token}/sendMessage"
            
            payload = {
                'chat_id': self.telegram_chat_id,
                'text': message,
                'parse_mode': 'Markdown'
            }
            
            response = requests.post(telegram_url, json=payload, timeout=10)
            
            if response.status_code == 200:
                print("‚úì Mensaje de prueba enviado correctamente")
                return True
            else:
                print(f"‚ö†Ô∏è  Error: {response.status_code}")
                return False
                
        except Exception as e:
            print(f"‚ö†Ô∏è  Error: {e}")
            return False


# Funci√≥n de utilidad para pruebas
if __name__ == "__main__":
    import sys
    
    # Configuraci√≥n de prueba
    config = {
        "console": True,
        "telegram": True
    }
    
    notifier = NotifierAI(config)
    
    if len(sys.argv) > 1 and sys.argv[1] == "test":
        # Enviar mensaje de prueba
        notifier.send_test_message()
    else:
        # Enviar notificaci√≥n de prueba
        test_data = {
            'categoria': 'Accidente Vial',
            'titulo': 'Choque m√∫ltiple en L√°zaro C√°rdenas deja 3 heridos',
            'ubicacion': 'Av. L√°zaro C√°rdenas altura Fundadores',
            'distancia_km': 2.1,
            'costco_cercano': 'Costco Valle Oriente',
            'costco_direccion': 'Av. L√°zaro C√°rdenas 800',
            'fuente': 'Milenio Monterrey',
            'url': 'https://www.milenio.com/ejemplo',
            'resumen': 'Accidente vehicular con tres personas lesionadas. Servicios de emergencia en el lugar.',
            'severity': 7,
            'severity_emoji': 'üö®',
            'victims': 3,
            'traffic_impact': 'high',
            'emergency_services': True
        }
        
        notifier.notify(test_data)
